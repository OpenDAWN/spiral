!function(window){"use strict";var hasWebKitAudioContext=(function(){var tem,ua=navigator.userAgent,M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(M[1])?(tem=/\brv[ :]+(\d+)/g.exec(ua)||[],"IE "+(tem[1]||"")):"Chrome"===M[1]&&(tem=ua.match(/\bOPR\/(\d+)/),null!==tem)?"Opera "+tem[1]:(M=M[2]?[M[1],M[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(tem=ua.match(/version\/(\d+)/i))&&M.splice(1,1,tem[1]),M.join(" "))}(),window.hasOwnProperty("webkitAudioContext")),hasAudioContext=window.hasOwnProperty("AudioContext");if(!hasWebKitAudioContext&&!hasAudioContext)return console.log("[Spiral] This browser does not support Web Audio API."),void(window._SPIRALFATAL=!0);hasWebKitAudioContext&&!hasAudioContext&&(window.AudioContext=window.webkitAudioContext,console.log("[Spiral] This browser still has webkitAudioContext. Patch applied."));var DEPRECATED_DICT={AudioContext:{createDelayNode:"createDelay",createGainNode:"createGain",createJavaScriptNode:"createScriptProcessor",createWaveTable:"createPeriodicWave"},AudioParam:{setTargetValueAtTime:"setTargetAtTime"},OscillatorNode:{noteOn:"start",noteOff:"stop",setWaveTable:"setPeriodicWave"},AudioBufferSourceNode:{noteOn:"start",noteOff:"stop"}};for(var nameSpace in DEPRECATED_DICT){var newMethods=DEPRECATED_DICT[nameSpace];for(var oldMethod in newMethods)window[nameSpace].prototype[oldMethod]=window[nameSpace].prototype[newMethods[oldMethod]]}}(window);
!function(){"use strict";window.Spiral=new Object;var SPIRAL_VERSION="0.0.2",EPSILON=.001;Object.defineProperties(window.AudioContext.prototype,{now:{get:function(){return this.currentTime}},DAC:{get:function(){return this.destination}},loadAudioFile:{value:function(fileURL){var _ctx=this,_promiseBody=function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",fileURL,!0),xhr.responseType="arraybuffer",xhr.onload=function(event){if(200===xhr.status)_ctx.decodeAudioData(xhr.response,resolve,reject);else{var errorMessage="[Spiral] XHR "+xhr.status+" "+xhr.statusText+". ("+fileURL+")";reject(errorMessage)}},xhr.onerror=function(event){reject("[Spiral] XHR Network failure. ("+fileURL+")")},xhr.send()};return new Promise(_promiseBody)}},createNodes:{value:function(target,nodeList){if("object"!=typeof target)throw"[Spiral] Creation target is not an object.";for(var name in nodeList){var functionName="create"+nodeList[name];if("function"!=typeof this[functionName])throw"[Spiral] Invalid AudioNode constructor: "+functionName;target[name]=this[functionName]()}}}}),Object.defineProperties(window.AudioNode.prototype,{to:{value:function(){if(arguments.length>0){for(var i=0;i<arguments.length;i++)this.connect(arguments[i]);return arguments[0]}return this}},cut:{value:function(){this.disconnect()}}}),Object.defineProperties(window.AudioParam.prototype,{step:{value:function(){if(arguments[0]instanceof Array)for(var i=0;i<arguments.length;i++)this.setValueAtTime.apply(this,arguments[i]);else this.setValueAtTime.apply(this,arguments);return this}},line:{value:function(){if(arguments[0]instanceof Array)for(var i=0;i<arguments.length;i++)this.linearRampToValueAtTime.apply(this,arguments[i]);else this.linearRampToValueAtTime.apply(this,arguments);return this}},expo:{value:function(){if(arguments[0]instanceof Array)for(var i=0;i<arguments.length;i++)this.exponentialRampToValueAtTime.apply(this,arguments[i]);else this.exponentialRampToValueAtTime.apply(this,arguments);return this}},slew:{value:function(targetValue,startTime,duration){var safeTargetValue=Math.max(EPSILON,targetValue),tau=duration/Math.log(1/safeTargetValue);return this.setTargetAtTime(safeTargetValue,startTime,tau),this.setValueAtTime(safeTargetValue,startTime+duration),this.linearRampToValueAtTime(targetValue,startTime+duration),this}}}),Object.defineProperties(window.Spiral,{version:{get:function(){return SPIRAL_VERSION}},generateUid:{value:function(){return"yxxxxxxx".replace(/[xy]/g,function(c){var r=8*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})}}})}();
!function(Spiral){"use strict";function SpiralEnvelope(){this._points=new Map}SpiralEnvelope.prototype.get=function(){var times=[],envelope=[];this._points.keys.forEach(function(key){times.push(key)}),times.sort();for(var i=0;i<times.length;i++)envelope.push([this._points.get(times[i]),times[i]]);return envelope},SpiralEnvelope.prototype.set=function(){for(var i=0;i<arguments.length;i++)this._points.set(arguments[i][1],arguments[i][0])},Object.defineProperties(Spiral,{clamp:{value:function(value,min,max){return Math.min(Math.max(value,min),max)}},random2f:{value:function(min,max){return min+Math.random()*(max-min)}},random2:{value:function(min,max){return Math.round(min+Math.random()*(max-min))}},mtof:{value:function(midi){return-1500>=midi?0:midi>1499?3.282417553401589e38:440*Math.pow(2,(Math.floor(midi)-69)/12)}},ftom:{value:function(freq){return Math.floor(freq>0?Math.log(freq/440)/Math.LN2*12+69:-1500)}},powtodb:{value:function(power){if(0>=power)return 0;var db=100+10/Math.LN10*Math.log(power);return 0>db?0:db}},dbtopow:{value:function(db){return 0>=db?0:(db>870&&(db=870),Math.exp(.1*Math.LN10*(db-100)))}},rmstodb:{value:function(rms){if(0>=rms)return 0;var db=100+20/Math.LN10*Math.log(rms);return 0>db?0:db}},dbtorms:{value:function(db){return 0>=db?0:(db>485&&(db=485),Math.exp(.05*Math.LN10*(db-100)))}},lintodb:{value:function(lin){return 20*(lin>1e-5?Math.log(lin)/Math.LN10:-5)}},dbtolin:{value:function(db){return Math.pow(10,db/20)}},veltoamp:{value:function(velocity){return velocity/127}},createEnvelope:{value:function(){var envelope=new SpiralEnvelope;return envelope.set.apply(envelope,arguments),envelope}}})}(window.Spiral);
!function(Spiral){"use strict";function _MIDIObject(type,channel,data1,data2){return{type:type,channel:channel,data1:data1,data2:data2}}function _parseMIDIMessage(msg){var channel=(15&msg.data[0])+1;switch(msg.data[0]>>4){case 8:return _MIDIObject("noteoff",channel,msg.data[1],msg.data[2]);case 9:return _MIDIObject("noteon",channel,msg.data[1],msg.data[2]);case 10:return _MIDIObject("polypressure",channel,msg.data[1],msg.data[2]);case 11:return _MIDIObject("controlchange",channel,msg.data[1],msg.data[2]);case 12:return _MIDIObject("programchange",channel,msg.data[1],null);case 13:return _MIDIObject("channelpressure",channel,msg.data[1],null);case 14:return _MIDIObject("pitchwheel",channel,msg.data[1]<<8||msg.data[2]);default:return null}}function SpiralMIDISource(midiInput){this.targets=new Set,this.input=midiInput,this.input.onmidimessage=this.routeMIDIMessage.bind(this)}Spiral.MIDI={};var _MIDISources=new Map,_MIDITargets=new Map,_isMIDIReady=!0,_onReadyCallback=null;return SpiralMIDISource.prototype.addTargets=function(){for(var i=0;i<arguments.length;i++){var targetObj=arguments[i];if(this.targets.has(targetObj))return void console.log("[Spiral] Cannot add a duplicate MIDI target: "+targetObj);this.targets.add(arguments[i])}},SpiralMIDISource.prototype.removeTargets=function(){for(var i=0;i<arguments.length;i++){var targetObj=arguments[i];if(!this.targets.has(targetObj))return void console.log("[Spiral] Target is not available for removal: "+targetObj);this.targets["delete"](targetObj)}},SpiralMIDISource.prototype.routeMIDIMessage=function(midiMessage){if(0!==this.targets.size){var parsedMessage=_parseMIDIMessage(midiMessage);for(var target in this.targets)target.onmidimessage(parsedMessage)}},Object.defineProperties(window.Spiral.MIDI,{ready:{value:function(callback){return _isMIDIReady?"function"!=typeof callback?void console.log("[Spiral] Invalid callback function for spiral-midi-ready event."):void(_onReadyCallback=callback):void 0}},report:{value:function(){var devices={sources:[],targets:[]};return _MIDISources.forEach(function(source,label){devices.sources.push(label)}),_MIDITargets.forEach(function(target,label){devices.targets.push(label)}),devices}},addTarget:{value:function(label,target){return"string"!=typeof label?void console.log("[Spiral] Target label should be a string."):_MIDITargets.has("label")?void console.log("[Spiral] Duplicate MIDI target label."):"function"!=typeof target.onmidimessage?void console.log("[Spiral] MIDI target does not have a valid MIDI message handler."):void _MIDITargets.set(label,target)}},route:{value:function(){for(var sources=[],targets=[],chain={to:function(){for(var i=0;i<arguments.length;i++){if(!_MIDITargets.has(arguments[i]))return void console.log("[Spiral] Cannot route invalid targets: "+arguments[i]);targets.push(_MIDITargets.get(arguments[i]))}if(0===targets.length)return void console.log("[Spiral] There is no target to route.");for(i=0;i<sources.length;i++)sources[i].addTargets.apply(sources[i],targets)}},i=0;i<arguments.length;i++)_MIDISources.has(arguments[i])?sources.push(_MIDISources.get(arguments[i])):console.log('[Spiral] Cannot route invalid source: "'+arguments[i]+'"');return 0===sources.length?(console.log("[Spiral] There is no source to route."),chain):chain}},unroute:{value:function(){for(var sources=[],targets=[],chain={from:function(){for(var i=0;i<arguments.length;i++){if(!_MIDITargets.has(arguments[i]))return void console.log("[Spiral] Cannot unroute invalid targets: "+arguments[i]);targets.push(_MIDITargets.get(arguments[i]))}if(0===targets.length)return void console.log("[Spiral] There is no target to unroute.");for(i=0;i<sources.length;i++)sources[i].removeTargets.apply(sources[i],targets)}},i=0;i<arguments.length;i++)_MIDISources.has(arguments[i])?sources.push(_MIDISources.get(arguments[i])):console.log('[Spiral] Cannot route invalid inputs: "'+arguments[i]+'"');return 0===sources.length?(console.log("[Spiral] There is no source to route."),chain):chain}}}),"function"!=typeof window.navigator.requestMIDIAccess?void console.log("[Spiral] Your browser does not support Web MIDI API!"):void window.navigator.requestMIDIAccess().then(function(midiAccess){return midiAccess.inputs.forEach(function(input){_MIDISources.has(input.name)||_MIDISources.set(input.name,new SpiralMIDISource(input))}),midiAccess.outputs.forEach(function(output){_MIDITargets.has(output.name)||_MIDITargets.set(output.name,new SpiralMIDISource(output))}),_isMIDIReady=!0,_onReadyCallback?(window.dispatchEvent(new Event("spiral-midi-ready",{detail:null})),void _onReadyCallback(Spiral.MIDI)):void console.log("[Spiral] MIDI.ready callback function is undefined.")},function(errorMessage){console.log("[Spiral] Requesting MIDI access failed: "+errorMessage)})}(window.Spiral);